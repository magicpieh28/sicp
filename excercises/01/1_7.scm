(load "helpers/assert.scm")
(load "helpers/format.scm")

(define (good-enough? guess x)
  (begin
    (format-display "x => " x)
    (format-display "guess => " guess)
    (format-display "square guess => " (square guess))
    (format-display "compare target => " (abs (- (square guess) x)))
    (newline)
    (< (abs (- (square guess) x)) 0.001)))

(define (average x y)
  (/ (+ x y) 2))

(define (improve guess x)
  (average guess (/ x guess)))

(define (sqrt-iter guess x)
  (if (good-enough? guess x)
    guess
    (begin
      ; (format-display "guess => " guess)
      (sqrt-iter (improve guess x) x))))

(define (sqrt x)
  (sqrt-iter 1 x))

(define (assert-range calculated min max)
  (assert (and (> calculated min) (< calculated max)) #t))

; ### Case with a large number
(assert-range (sqrt 10000000000.0) 100000 100000.001)
; guess => 1
; guess => 4097/2
; guess => 16801793/16388
; guess => 283400296579073/550695567368
; guess => 81557904031141790541270188033/312134574233744150420979728
; guess => 7050756766954737029245596739012566685948662926640139927553/50914083300314017024143270350815534951221306965282390048
; guess => 60331001912321160773832548403761376126628712542292727387098324425884757165460337019797833563707406497747201964244993/717965634725972452189044001976874190865267406012121852434549569722951421478360569962302140537669607799026816385088
; guess => 5751213968988530535623946477845420794414879433515032032146220897464560259208724648635801760719200310523631241508589108002626877322834648384317545452188656661928876536001521074293205976311685871626413930009870080653979335266838249473/86631172163267040015820624735574598208787951328862020807790610964442778631855427494919125269599835119822039071167139315841956612740155099173275039845254603870161052775625683534716520179992058212264029087738299663696221478927728768
; guess => 63816778237691897535946081768782103003849527066770454803932035351334973514518866894915123924007849629396395163563003535067589822247970551680173047625734635171619028163155065442837481928635183060114642211470346400728559174761857389271147502208364011763049287933536982354653265674350005530555387160960523082184724141777863334419360085342586851694593426148857395210698220792283960997072338545760185314823895975883338259623614107533138622013212327929608323711756664833/996468814990463472146574414238638478355423100872287449455087455687906336195252526180146785325768924686156748765871204868817925452777829451083524068318078938386334215429715290738226169680203402619683262712759792606405494314963800599092065397685821525204607019525726775382477283881468515135060493827552619120159728465834538967711993808527489979772048855316799707689992782510768998608326787258202182039353410172051188477239486368985625917076722077175163065725878528
; guess => 8139704791160596108422718052259788355626828991745751645161765535812116920019914703668751783895972725902281693435881467934725833214013079151519044175430259207531755749902571995000140572943607961118969337459825548625216940540747904533815056338695873819085645865857939685954360723353594994931147721567982668191191784838055557269507941542436283040020168862981495240572574333162083337111388824312464272324017844743822076112090226111359658016213151264153712359671484664469727691291764103653599553683243851600930124369879288709950691524438373825144118012127653773398709752362331771846535019637484487899699324295187642609332500315059329024923310361874600862825837568000930346168676850954887892115967450588764838808391948218005533132732553415063530318072946990628303330426814699849470784558497422803653033110010719525468142913590677583983405051937939038667550378552977090294276855369998969678513060719035082219116980215663844472784945153/127182858774044085979131958913187013608486426728050190252348610893687406994583247276677755630359902515700283005102658564465310998323669498895659233611263728971486831604919349178643498329170991417387014842618538277475828590713190793374230166460845199849626145700050553996986434714490959016961310231452404604752899322518493763597096307777584975798903170549083062846971452396134043818203780255603100627012916227032305450289591094298701362232495725074150357300980895333836271455633186103422567226695883610687793574269171522173122284012437240862098112638577579225044490506102329005856293434768555355283900647188581736395917659423910557754011686731658578778531917127141354648175474000291377862033557647842396622096023059411317409037000209034150860636962118614424715815371997373584142560105845171793352586143156623335102577472114898457431679636891332003950147400084989053766292734418182339090558830751713770882939439526834616334811648
; Test failed

; ### Case with a small number
(assert-range (sqrt 0.00001) 0.003 0.004)
; guess => 1
;   sqrt-iter: guess=1, x=4
;   improve: (4 + 1) / 2
; guess => 5/2 => 2.5
;   sqrt-iter: guess=5/2, x=4
;   improve: (5/2 + 4/(5/2)) / 2
;     => (5/2)/2 + (8/5)/2
;     => 5/4 + 4/5
;     => 41/20
; guess => 41/20 => 2.05
;   
; guess => 3281/1640 => 2.0006097561
; Test failed

; ### Why it is inappropriate to compute the square root of an absurdly large number using the `sqrt` function
; The numerator(分子) and denominator(分母) involved in the division become extremely large, causing the computation to take an impractically long time.
; This happens because, instead of passing the result of the division (normal-order evaluation) to the recursive function,
; the function passes unevaluated expressions as arguments (applicative-order evaluation).
; As a result, repeated averaging causes the numerator and denominator to grow to unreasonable sizes.

; ### Why it is inappropriate to compute the square root of an extremely small number using the `sqrt` function
; The current termination test compares the square of the guess directly with `x`, and stops when the square of the `guess` is sufficiently close to `x`.
; However, if x is extremely small, the threshold(0.001) used for this comparison may become larger than the actual difference between the square of the `guess` and `x`, making it impossible to judge convergence correctly.


(define (new-good-enough? prev-guess current-guess)
  (begin
    (define change-rate (* (/ (abs (- current-guess prev-guess)) prev-guess) 100))
    (format-display "change-rate => " change-rate)
    (newline)
    (< change-rate 0.001)))

(define (new-sqrt-iter prev-guess current-guess x)
  (if (new-good-enough? prev-guess current-guess)
    current-guess
    (begin
      (format-display "prev-guess => " prev-guess)
      (format-display "current-guess => " current-guess)
      (new-sqrt-iter current-guess (improve current-guess x) x))))

(define (square-root x)
  (new-sqrt-iter 1 0.1 x))

(assert-range (square-root 10000000) 100000 100000.001)

(assert-range (square-root 0.00001) 0.003 0.004)
